<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Selecting priors to power-scale and posterior quantities to check â€¢ priorsense</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="selecting_priors_and_quantities_files/libs/quarto-html/popper.min.js"></script><script src="selecting_priors_and_quantities_files/libs/quarto-html/tippy.umd.min.js"></script><link href="selecting_priors_and_quantities_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="selecting_priors_and_quantities_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Selecting priors to power-scale and posterior quantities to check">
<meta property="og:image" content="https://n-kall.github.io/priorsense/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">priorsense</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/powerscaling.html">Power-scaling sensitivity analysis</a></li>
    <li><a class="dropdown-item" href="../articles/priorsense_with_jags.html">Using priorsense with JAGS</a></li>
    <li><a class="dropdown-item" href="../articles/quantity_of_interest.html">Quantities of interest for sensitivity checks</a></li>
    <li><a class="dropdown-item" href="../articles/selecting_priors_and_quantities.html">Selecting priors to power-scale and posterior quantities to check</a></li>
    <li><a class="dropdown-item" href="../articles/sensitivity_diagnostic.html">Interpreting sensitivity diagnostics</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/n-kall/priorsense/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Selecting priors to power-scale and posterior quantities to check</h1>




      <small class="dont-index">Source: <a href="https://github.com/n-kall/priorsense/blob/main/vignettes/selecting_priors_and_quantities.qmd" class="external-link"><code>vignettes/selecting_priors_and_quantities.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Priorsense is a package for prior and likelihood sensitivity checks. It can be used to detect prior-data conflict and weak likelihood.</p>
<p>This vignette demonstrates two different but related concepts: (1) selecting different priors to power-scale, and (2) specifying which posterior quantities to check the sensitivity of.</p>
<p>We will fit two different models on the same data set. The first is a linear model, which has easily interpretable parameters.</p>
<p>The second model includes splines and the spline coefficient parameters are not as easy to interpret. The specific model is not important, as the general principles apply for any model that has many parameters, correlated parameters or uninterpretable parameters. This includes other models with smooths, non-linear models, Gaussian processes and other more complex models.</p>
<p>The features used here require <code>brms</code> version 2.22.11 or greater.</p>
<p>The main takeaways for this vignette are:</p>
<ul>
<li><p>prior tagging makes it possible to partition priors to make selective power-scaling easier</p></li>
<li><p>in more complex models, it is often better to check the sensitivity of predictions or predictive measures rather than the parameters</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/n-kall/priorsense" class="external-link">priorsense</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>priorsense.plot_help_text <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We use the <code>airquality</code> data set, and fit a model predicting the amount of ozone based on the temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">aq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="linear-model">Linear model<a class="anchor" aria-label="anchor" href="#linear-model"></a>
</h2>
<p>We first fit a linear model, with some priors specified. For each of the specified priors we add a <code>tag</code>, which will be used later to select which priors are power-scaled.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_lin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">Temp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">aq</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"Temp"</span>, tag <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span>, tag <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span>, tag <span class="op">=</span> <span class="st">"intercept"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Rather than working with the <code>brmsfit</code> object directly, we will first extract the posterior draws. We will work with <code>draws</code> object using the <code>posterior</code> package so derived quantities can be added more easily. The <code>brmsfit</code> does not include the <code>log_lik</code> evaluations, so we will add those to the draws object using <code><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">posterior::bind_draws</a></code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_draws_lin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">fit_lin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span><span class="fu"><a href="../reference/log_lik_draws.html">log_lik_draws</a></span><span class="op">(</span><span class="va">fit_lin</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>As the model is simple, with only one predictor, and each parameter is directly interpretable, we can perform the power-scaling sensitivity check directly on all the marginal posteriors of the parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_lin</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: all priors
Likelihood selection: all data

    variable prior likelihood                     diagnosis
 b_Intercept 0.006      0.091                             -
      b_Temp 0.006      0.093                             -
       sigma 0.062      0.083 potential prior-data conflict
   Intercept 0.005      0.077                             -</code></pre>
</div>
</div>
<p>This indicates that when we power-scale all the priors, the posterior of sigma is changing.</p>
<p>Instead of looking at the parameter posteriors, we can check the sensitivity of predictions and predictive performance measures.</p>
<p>For predictions, we will focus on the predictions at the minimum, median and maximum temperatures from the data.</p>
<p>For predictive performance measures, we will use the in-sample Bayesian R2 and log-score.</p>
<p>We first define a log-score function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logscore</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/log_lik.html" class="external-link">log_lik</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<p>And then bind the draws of the predictions and measures to the posterior draws using <code><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">posterior::bind_draws()</a></code>. For this we will use the <code>predictions_as_draws</code> helper function provided by <code>priorsense</code> which transforms predictions from <code>brms</code> to draws objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_draws_lin</span> <span class="op">&lt;-</span> <span class="va">post_draws_lin</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">fit_lin</span>,</span>
<span>      predict_fn <span class="op">=</span> <span class="va">bayes_R2</span>,</span>
<span>      prediction_names <span class="op">=</span> <span class="st">"R2"</span>,</span>
<span>      summary <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">fit_lin</span>,</span>
<span>      predict_fn <span class="op">=</span> <span class="va">logscore</span>,</span>
<span>      prediction_names <span class="op">=</span> <span class="st">"logscore"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">fit_lin</span>,</span>
<span>      predict_fn <span class="op">=</span> <span class="va">posterior_epred</span>,</span>
<span>      prediction_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_minTemp"</span>, <span class="st">"pred_medianTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span>,</span>
<span>      newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_lin</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: all priors
Likelihood selection: all data

        variable prior likelihood                     diagnosis
     b_Intercept 0.006      0.091                             -
          b_Temp 0.006      0.093                             -
           sigma 0.062      0.083 potential prior-data conflict
       Intercept 0.005      0.077                             -
              R2 0.005      0.120                             -
        logscore 0.009      0.430                             -
    pred_minTemp 0.006      0.088                             -
 pred_medianTemp 0.006      0.076                             -
    pred_maxTemp 0.007      0.090                             -</code></pre>
</div>
</div>
<p>In this case, these predictive metrics do not appear to be sensitive to power-scaling the prior. If we are focused on prediction, we might not be concerned about the potential prior-data conflict for the sigma parameter. However, as the model is simple and sigma is interpretable we can continue investigation.</p>
<p>We can confirm that it is the sigma prior that is causing the possible prior-data conflict, by using the <code>prior_selection</code> argument and specifying the <code>tag</code> we defined when creating the priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_lin</span>,</span>
<span>  prior_selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigma"</span>, <span class="st">"intercept"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: sigma, intercept
Likelihood selection: all data

        variable prior likelihood                     diagnosis
     b_Intercept 0.004      0.091                             -
          b_Temp 0.004      0.093                             -
           sigma 0.062      0.083 potential prior-data conflict
       Intercept 0.005      0.077                             -
              R2 0.006      0.120                             -
        logscore 0.009      0.430                             -
    pred_minTemp 0.004      0.088                             -
 pred_medianTemp 0.006      0.076                             -
    pred_maxTemp 0.004      0.090                             -</code></pre>
</div>
</div>
<p>And we can visualise the conflict.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale_plots.html">powerscale_plot_dens</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_lin</span>,</span>
<span>  variable <span class="op">=</span> <span class="st">"sigma"</span>,</span>
<span>  prior_selection <span class="op">=</span> <span class="st">"sigma"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="selecting_priors_and_quantities_files/figure-html/unnamed-chunk-10-1.png" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Here we can see that there is a tendency for the posterior of sigma to shift closer to zero when the prior is strengthened (power-scaling alpha &gt; 1). In this case, we did not have strong prior information that informed the prior, so we can consider a wider prior for sigma.</p>
</section><section class="section level2"><h2 id="spline-model">Spline model<a class="anchor" aria-label="anchor" href="#spline-model"></a>
</h2>
<p>Next we extend our model by adding splines (and use a wider prior on sigma). This model is more complex, so it is more important to focus on checking the sensitivity of specific posterior quantities, rather than all the parameters. Here we will focus on the Bayesian R2, the log-score and the predictions at the minimum, median and maximum of the observed temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_spline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">Temp</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">aq</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"sTemp_1"</span>, tag <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sds"</span>, coef <span class="op">=</span> <span class="st">"s(Temp)"</span>, tag <span class="op">=</span> <span class="st">"sds"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span>, tag <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span>, tag <span class="op">=</span> <span class="st">"intercept"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_draws_spline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">fit_spline</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span><span class="fu"><a href="../reference/log_lik_draws.html">log_lik_draws</a></span><span class="op">(</span><span class="va">fit_spline</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">fit_spline</span>,</span>
<span>      predict_fn <span class="op">=</span> <span class="va">bayes_R2</span>,</span>
<span>      prediction_names <span class="op">=</span> <span class="st">"R2"</span>, summary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">fit_spline</span>,</span>
<span>        predict_fn <span class="op">=</span> <span class="va">logscore</span>,</span>
<span>        prediction_names <span class="op">=</span> <span class="st">"logscore"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://mc-stan.org/posterior/reference/bind_draws.html" class="external-link">bind_draws</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/predictions_as_draws.html">predictions_as_draws</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">fit_spline</span>,</span>
<span>        predict_fn <span class="op">=</span> <span class="va">posterior_epred</span>,</span>
<span>        prediction_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_minTemp"</span>, <span class="st">"pred_medianTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span>,</span>
<span>      newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">aq</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
</div>
<p>We start with power-scaling all priors, but only looking at the effect on <code>R2</code> and <code>logscore</code> and the predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_spline</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R2"</span>, <span class="st">"logscore"</span>, <span class="st">"pred_minTemp"</span>, <span class="st">"pred_medianTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: all priors
Likelihood selection: all data

        variable prior likelihood                     diagnosis
              R2 0.061      0.242 potential prior-data conflict
        logscore 0.043      0.422                             -
    pred_minTemp 0.030      0.062                             -
 pred_medianTemp 0.044      0.124                             -
    pred_maxTemp 0.037      0.130                             -</code></pre>
</div>
</div>
<p>We see sensitivity in both measures. Next, we selectively power-scale different priors by specifying the corresponding <code>tag</code> in <code>prior_selection</code>.</p>
<p>As this model introduced a prior on the <code>sds</code> term, we can start there.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_spline</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R2"</span>, <span class="st">"logscore"</span>, <span class="st">"pred_minTemp"</span>, <span class="st">"pred_medianTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span>,</span>
<span>  prior_selection <span class="op">=</span> <span class="st">"sds"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: sds
Likelihood selection: all data

        variable prior likelihood                     diagnosis
              R2 0.066      0.242 potential prior-data conflict
        logscore 0.048      0.422                             -
    pred_minTemp 0.029      0.062                             -
 pred_medianTemp 0.044      0.124                             -
    pred_maxTemp 0.037      0.130                             -</code></pre>
</div>
</div>
<p>There is clear sensitivity to this prior. We can check all the other priors at once by providing a vector as the <code>prior_selection</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale-sensitivity.html">powerscale_sensitivity</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_spline</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R2"</span>, <span class="st">"logscore"</span>, <span class="st">"pred_minTemp"</span>, <span class="st">"pred_minTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span>,</span>
<span>  prior_selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"intercept"</span>, <span class="st">"sigma"</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sensitivity based on cjs_dist
Prior selection: intercept, sigma, b
Likelihood selection: all data

     variable prior likelihood diagnosis
           R2 0.007      0.242         -
     logscore 0.008      0.422         -
 pred_minTemp 0.003      0.062         -
 pred_maxTemp 0.003      0.130         -</code></pre>
</div>
</div>
<p>We can visualise the effect of power-scaling the <code>sds</code> prior on the posterior <code>R2</code>, <code>logscore</code> and the predictions. Here we visualise the change in posterior mean and standard deviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/powerscale_plots.html">powerscale_plot_quantities</a></span><span class="op">(</span></span>
<span>  <span class="va">post_draws_spline</span>,</span>
<span>  div_measure <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R2"</span>, <span class="st">"logscore"</span>, <span class="st">"pred_minTemp"</span>, <span class="st">"pred_medianTemp"</span>, <span class="st">"pred_maxTemp"</span><span class="op">)</span>,</span>
<span>  prior_selection <span class="op">=</span> <span class="st">"sds"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="selecting_priors_and_quantities_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Although not extremely sensitive, there is a tendency for the in-sample predictive performance measures to decrease as the prior is strengthened. This is natural when strengthening the prior leads to less flexibility in the model. In this case larger <code>sds</code> implies more flexibility in the spline component of the model. If this is not what we are intending with the choice of prior on <code>sds</code>, we may want to rethink and change it.</p>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Noa Kallioinen, Topi Paananen, Paul-Christian BÃ¼rkner, Aki Vehtari.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
